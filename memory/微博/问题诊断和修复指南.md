# 微博应用问题诊断和修复指南

## 常见问题及解决方案

### 1. 微博内容不生成

**症状：** 聊天很久了，但是没有生成微博内容

**可能原因：**
- API未配置或配置错误
- 自动监听器未启动
- 消息数量未达到阈值
- 系统正在处理中

**诊断步骤：**
```javascript
// 1. 检查API配置
console.log('API可用性:', window.mobileCustomAPIConfig?.isAPIAvailable());

// 2. 检查监听器状态
console.log('监听器状态:', window.weiboAutoListener?.isListening);
console.log('监听器设置:', window.weiboAutoListener?.settings);

// 3. 检查消息数量
const messageCount = window.weiboAutoListener?.getCurrentMessageCount();
const threshold = window.weiboManager?.getSettings()?.threshold;
console.log(`消息数量: ${messageCount}, 阈值: ${threshold}`);

// 4. 检查处理状态
console.log('管理器处理中:', window.weiboManager?.isCurrentlyProcessing());
```

**解决方案：**
```javascript
// 配置API
window.mobileCustomAPIConfig.setConfig({
    url: 'your-api-url',
    apiKey: 'your-api-key',
    model: 'your-model'
});

// 启动监听器
window.weiboAutoListener.start();

// 降低阈值
window.weiboManager.setThreshold(5);

// 手动触发生成
await window.weiboManager.generateWeiboContent();
```

### 2. 界面显示空白或异常

**症状：** 微博界面显示空白，或者显示"暂无微博"

**可能原因：**
- 微博内容解析失败
- 聊天记录中没有微博格式的内容
- UI渲染异常

**诊断步骤：**
```javascript
// 1. 检查微博数据
const weiboData = window.weiboUI?.getCurrentWeiboData();
console.log('微博数据:', weiboData);

// 2. 检查聊天记录
const chatData = window.mobileContextEditor?.getCurrentChatData();
console.log('聊天消息数量:', chatData?.messages?.length);

// 3. 检查第一条消息内容
if (chatData?.messages?.length > 0) {
    const firstMessage = chatData.messages[0].mes;
    console.log('第一条消息包含微博标记:', 
        firstMessage.includes('<!-- WEIBO_CONTENT_START -->'));
}
```

**解决方案：**
```javascript
// 强制刷新界面
window.weiboUI.refreshWeiboList();

// 重新生成微博内容
await window.weiboManager.generateWeiboContent();

// 检查第1楼层状态
window.weiboManager.checkFirstLayerStatus();
```

### 3. 自动监听不工作

**症状：** 开启了自动监听，但是不会自动生成微博

**可能原因：**
- 监听器未正确启动
- 监听器被禁用
- 检查间隔设置过长
- 阈值设置过高

**诊断步骤：**
```javascript
// 获取完整诊断信息
const diagnosis = window.weiboAutoListener?.diagnose();
console.log('监听器诊断:', diagnosis);

// 检查具体设置
const stats = window.weiboAutoListener?.getStats();
console.log('监听器统计:', stats);
```

**解决方案：**
```javascript
// 重启监听器
window.weiboAutoListener.stop();
setTimeout(() => {
    window.weiboAutoListener.setEnabled(true);
    window.weiboAutoListener.start();
}, 1000);

// 调整设置
window.weiboAutoListener.updateSettings({
    enabled: true,
    checkIntervalMs: 3000,  // 3秒检查一次
    debounceMs: 500,        // 0.5秒防抖
    threshold: 5            // 5条消息触发
});
```

### 4. 发微博功能不工作

**症状：** 点击发微博按钮没有反应，或者发布失败

**可能原因：**
- 事件绑定失败
- API调用失败
- 内容格式错误

**诊断步骤：**
```javascript
// 检查事件绑定
console.log('发微博按钮存在:', !!document.getElementById('submit-post-btn'));

// 检查微博管理器
console.log('微博管理器可用:', !!window.weiboManager);
console.log('发微博API可用:', !!window.weiboManager?.sendPostToAPI);
```

**解决方案：**
```javascript
// 重新绑定事件
window.weiboUI.bindEvents();

// 手动测试发微博
await window.weiboManager.sendPostToAPI('测试微博内容');
```

### 5. 评论功能异常

**症状：** 无法评论微博，或者评论后没有反应

**可能原因：**
- 评论事件未绑定
- API调用失败
- 评论格式错误

**解决方案：**
```javascript
// 重新绑定评论事件
window.weiboUI.bindCommentEvents();

// 手动测试评论
await window.weiboManager.sendReplyToAPI('测试评论内容');
```

### 6. 设置不保存

**症状：** 修改设置后，刷新页面设置丢失

**可能原因：**
- 本地存储被禁用
- 保存函数未调用
- 存储空间不足

**诊断步骤：**
```javascript
// 检查本地存储
try {
    localStorage.setItem('test', 'test');
    localStorage.removeItem('test');
    console.log('本地存储可用');
} catch (e) {
    console.error('本地存储不可用:', e);
}

// 检查设置保存
const settings = JSON.parse(localStorage.getItem('weiboManagerSettings') || '{}');
console.log('已保存的设置:', settings);
```

**解决方案：**
```javascript
// 手动保存设置
window.weiboManager.saveSettings();

// 清理存储空间
localStorage.clear();
```

## 系统诊断工具

### 完整系统检查
```javascript
function fullSystemDiagnosis() {
    const report = {
        timestamp: new Date().toISOString(),
        modules: {
            contextEditor: !!window.mobileContextEditor,
            apiConfig: !!window.mobileCustomAPIConfig,
            weiboManager: !!window.weiboManager,
            weiboUI: !!window.weiboUI,
            autoListener: !!window.weiboAutoListener,
            weiboStyles: !!window.weiboStyles
        },
        api: {
            available: window.mobileCustomAPIConfig?.isAPIAvailable(),
            config: window.mobileCustomAPIConfig?.getCurrentConfig()
        },
        manager: {
            initialized: window.weiboManager?.isInitialized,
            processing: window.weiboManager?.isCurrentlyProcessing(),
            settings: window.weiboManager?.getSettings()
        },
        listener: {
            listening: window.weiboAutoListener?.isListening,
            stats: window.weiboAutoListener?.getStats()
        },
        ui: {
            currentTab: window.weiboUI?.currentTab,
            dataAvailable: !!window.weiboUI?.getCurrentWeiboData()?.posts?.length
        },
        storage: {
            available: (() => {
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                    return true;
                } catch (e) {
                    return false;
                }
            })(),
            settings: !!localStorage.getItem('weiboManagerSettings')
        }
    };
    
    console.log('=== 微博应用系统诊断报告 ===');
    console.log(JSON.stringify(report, null, 2));
    return report;
}

// 运行诊断
fullSystemDiagnosis();
```

### 性能监控
```javascript
function performanceMonitor() {
    const startTime = performance.now();
    
    // 监控生成时间
    const originalGenerate = window.weiboManager.generateWeiboContent;
    window.weiboManager.generateWeiboContent = async function() {
        const genStart = performance.now();
        const result = await originalGenerate.call(this);
        const genEnd = performance.now();
        console.log(`微博生成耗时: ${genEnd - genStart}ms`);
        return result;
    };
    
    // 监控UI渲染时间
    const originalRefresh = window.weiboUI.refreshWeiboList;
    window.weiboUI.refreshWeiboList = function() {
        const renderStart = performance.now();
        const result = originalRefresh.call(this);
        const renderEnd = performance.now();
        console.log(`UI渲染耗时: ${renderEnd - renderStart}ms`);
        return result;
    };
}
```

### 错误捕获
```javascript
function setupErrorCapture() {
    // 捕获全局错误
    window.addEventListener('error', (e) => {
        if (e.filename?.includes('weibo')) {
            console.error('微博应用错误:', e.error);
        }
    });
    
    // 捕获Promise错误
    window.addEventListener('unhandledrejection', (e) => {
        if (e.reason?.stack?.includes('weibo')) {
            console.error('微博应用Promise错误:', e.reason);
        }
    });
}

setupErrorCapture();
```

## 修复脚本

### 重置微博应用
```javascript
function resetWeiboApp() {
    console.log('开始重置微博应用...');
    
    // 停止监听器
    if (window.weiboAutoListener) {
        window.weiboAutoListener.stop();
    }
    
    // 清除设置
    localStorage.removeItem('weiboManagerSettings');
    localStorage.removeItem('weiboControlSettings');
    localStorage.removeItem('mobile_weibo_custom_styles');
    localStorage.removeItem('mobile_weibo_custom_prefix');
    
    // 重新初始化
    setTimeout(() => {
        if (window.weiboManager) {
            window.weiboManager.loadSettings();
        }
        if (window.weiboAutoListener) {
            window.weiboAutoListener.start();
        }
        console.log('微博应用重置完成');
    }, 1000);
}
```

### 修复事件绑定
```javascript
function fixEventBindings() {
    console.log('修复事件绑定...');
    
    // 重新绑定UI事件
    if (window.weiboUI) {
        window.weiboUI.bindEvents();
    }
    
    // 重新绑定控制面板事件
    if (window.weiboControlApp) {
        window.weiboControlApp.bindEvents();
    }
    
    console.log('事件绑定修复完成');
}
```

### 强制同步数据
```javascript
async function forceSyncData() {
    console.log('强制同步数据...');
    
    try {
        // 清除微博内容
        await window.weiboManager.clearWeiboContent();
        
        // 重新生成
        await window.weiboManager.generateWeiboContent();
        
        // 刷新界面
        window.weiboUI.refreshWeiboList();
        
        console.log('数据同步完成');
    } catch (error) {
        console.error('数据同步失败:', error);
    }
}
```

## 预防措施

### 定期健康检查
```javascript
// 每5分钟检查一次系统状态
setInterval(() => {
    const health = {
        listener: window.weiboAutoListener?.isListening,
        manager: !window.weiboManager?.isCurrentlyProcessing(),
        api: window.mobileCustomAPIConfig?.isAPIAvailable()
    };
    
    if (!health.listener || !health.manager || !health.api) {
        console.warn('微博应用健康检查异常:', health);
    }
}, 5 * 60 * 1000);
```

### 自动恢复机制
```javascript
function setupAutoRecovery() {
    // 监听器自动恢复
    setInterval(() => {
        if (window.weiboAutoListener?.settings?.enabled && 
            !window.weiboAutoListener?.isListening) {
            console.log('自动恢复监听器...');
            window.weiboAutoListener.start();
        }
    }, 30000);
}

setupAutoRecovery();
```

通过这些诊断和修复工具，可以快速定位和解决微博应用的各种问题，确保系统稳定运行。
