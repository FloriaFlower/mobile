# 微博应用技术实现细节

## 整体架构

### 模块化设计
微博应用采用模块化架构，每个文件负责特定功能：

```
微博应用
├── weibo-manager.js      (核心业务逻辑)
├── weibo-ui.js          (界面显示逻辑)
├── weibo-auto-listener.js (自动监听功能)
├── weibo-control-app.js  (控制面板)
├── weibo-styles.js      (风格定义)
├── weibo-ui.css         (界面样式)
└── weibo-control-app.css (控制面板样式)
```

### 数据流向
```
聊天记录 → 自动监听器 → 微博管理器 → AI模型 → 生成内容 → 界面显示
```

## 核心技术实现

### 1. 内容生成流程

**步骤1：监听聊天变化**
```javascript
// weibo-auto-listener.js
checkForChanges() {
    const currentCount = this.getCurrentMessageCount();
    const messageIncrement = currentCount - this.lastMessageCount;
    
    if (messageIncrement >= threshold) {
        this.safeDebounceAutoGenerate();
    }
}
```

**步骤2：构建API请求**
```javascript
// weibo-manager.js
const messages = [
    {
        role: 'system',
        content: stylePrompt  // 风格提示词
    },
    {
        role: 'user', 
        content: contextInfo  // 聊天上下文
    }
];
```

**步骤3：调用AI模型**
```javascript
const response = await window.mobileCustomAPIConfig.callAPI(messages, {
    temperature: 0.8,
    max_tokens: 2000
});
```

**步骤4：更新聊天内容**
```javascript
const success = await this.updateContextWithWeibo(response.content);
```

### 2. 内容解析机制

**微博格式规范：**
```
[热搜|话题标题|热度值]
[博文|博主昵称|博文ID|博文内容|点赞数|转发数|评论数]
[评论|评论者昵称|博文ID|评论内容|点赞数]
[转发|转发者昵称|博文ID|转发评论]
```

**解析实现：**
```javascript
// weibo-ui.js
parseWeiboContent(content) {
    const hotSearchRegex = /\[热搜\|([^|]+)\|([^\]]+)\]/g;
    const postRegex = /\[博文\|([^|]+)\|([^|]+)\|([^|]+)\|([^|]+)\|([^|]+)\|([^\]]+)\]/g;
    const commentRegex = /\[评论\|([^|]+)\|([^|]+)\|([^|]+)\|([^\]]+)\]/g;
    const repostRegex = /\[转发\|([^|]+)\|([^|]+)\|([^\]]+)\]/g;
    
    // 解析各种类型的内容...
}
```

### 3. 状态管理

**监听器状态：**
```javascript
// weibo-auto-listener.js
class WeiboAutoListener {
    constructor() {
        this.isListening = false;
        this.isProcessingRequest = false;
        this.lastMessageCount = 0;
        this.generationCount = 0;
    }
}
```

**管理器状态：**
```javascript
// weibo-manager.js
class WeiboManager {
    constructor() {
        this.isProcessing = false;
        this.isMonitoringGeneration = false;
        this.currentSettings = {
            enabled: true,
            selectedStyle: '微博网友',
            autoUpdate: false,
            threshold: 10
        };
    }
}
```

### 4. 事件系统

**全局事件绑定：**
```javascript
// weibo-ui.js
bindEvents() {
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('nav-item')) {
            this.switchTab(e.target.dataset.tab);
        }
        
        if (e.target.closest('.action-btn')) {
            this.handleAction(e.target.closest('.action-btn'));
        }
    });
}
```

**模块间通信：**
```javascript
// 通过全局对象进行通信
window.weiboManager.generateWeiboContent();
window.weiboUI.refreshWeiboList();
window.weiboAutoListener.start();
```

### 5. 数据持久化

**设置保存：**
```javascript
// weibo-manager.js
saveSettings() {
    localStorage.setItem('weiboManagerSettings', 
        JSON.stringify(this.currentSettings));
}

loadSettings() {
    const saved = localStorage.getItem('weiboManagerSettings');
    if (saved) {
        this.currentSettings = {...this.currentSettings, ...JSON.parse(saved)};
    }
}
```

**自定义风格保存：**
```javascript
// weibo-styles.js
saveCustomStyles() {
    const customStyles = {};
    // 只保存非预设风格
    for (const [name, prompt] of Object.entries(this.styles)) {
        if (!presetStyles.includes(name)) {
            customStyles[name] = prompt;
        }
    }
    localStorage.setItem('mobile_weibo_custom_styles', 
        JSON.stringify(customStyles));
}
```

### 6. 错误处理机制

**API调用错误处理：**
```javascript
// weibo-manager.js
async generateWeiboContent() {
    try {
        this.isProcessing = true;
        this.updateGenerationStatus('正在生成微博内容...');
        
        // API调用逻辑...
        
    } catch (error) {
        console.error('[Weibo Manager] 生成微博内容时发生错误:', error);
        this.updateGenerationStatus('生成过程中发生错误');
        
        if (window.showMobileToast) {
            window.showMobileToast(`❌ 微博生成失败: ${error.message}`, 'error');
        }
        
        return false;
    } finally {
        this.isProcessing = false;
    }
}
```

**监听器错误处理：**
```javascript
// weibo-auto-listener.js
async checkForChanges() {
    try {
        // 检查逻辑...
    } catch (error) {
        console.error('[Weibo Auto Listener] 检查变化时发生错误:', error);
        this.updateStatus('检查错误');
    }
}
```

### 7. 性能优化

**防抖处理：**
```javascript
// weibo-auto-listener.js
debounceAutoGenerate() {
    if (this.debounceTimer) {
        clearTimeout(this.debounceTimer);
    }
    
    this.debounceTimer = setTimeout(async () => {
        await this.safeDebounceAutoGenerate();
    }, this.settings.debounceMs);
}
```

**请求锁机制：**
```javascript
// weibo-manager.js
async generateWeiboContent() {
    if (this.isProcessing) {
        console.log('[Weibo Manager] 正在处理中，跳过本次请求');
        return;
    }
    
    this.isProcessing = true;
    // 处理逻辑...
    this.isProcessing = false;
}
```

**内容缓存：**
```javascript
// weibo-ui.js
getCurrentWeiboData() {
    // 从最新消息开始检查，避免重复解析
    for (let i = chatData.messages.length - 1; i >= 0; i--) {
        const message = chatData.messages[i];
        if (message && message.mes) {
            const weiboData = this.parseWeiboContent(message.mes);
            if (weiboData.posts.length > 0 || weiboData.hotSearches.length > 0) {
                return weiboData;
            }
        }
    }
}
```

### 8. 界面渲染优化

**虚拟滚动（简化版）：**
```javascript
// weibo-ui.js
getPostHTML(post, comments, reposts) {
    // 只显示前3条评论，其余折叠
    ${comments.slice(0, 3).map(comment => `...`).join('')}
    ${comments.length > 3 ? `
        <div class="view-more-comments">
            <button class="view-more-btn">查看全部${comments.length}条评论</button>
        </div>
    ` : ''}
}
```

**懒加载图片：**
```javascript
// 头像生成而非加载图片
generateAvatar(name) {
    const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', ...];
    const colorIndex = name.length % colors.length;
    return {
        bg: colors[colorIndex],
        text: name[0] || '?'
    };
}
```

### 9. 移动端适配

**响应式设计：**
```css
/* weibo-ui.css */
@media (max-width: 480px) {
    .weibo-nav {
        gap: 10px;
    }
    
    .nav-item {
        padding: 6px 12px;
        font-size: 13px;
    }
    
    .dialog-content {
        width: 95%;
        margin: 20px 0;
    }
}
```

**触摸优化：**
```css
.action-btn {
    padding: 8px 12px;  /* 增大点击区域 */
    cursor: pointer;
    transition: all 0.2s ease;
}

.action-btn:active {
    animation: pulse 0.2s ease-out;  /* 点击反馈 */
}
```

## 集成方式

### 与手机框架集成
```javascript
// 注册全局函数供手机框架调用
window.getWeiboAppContent = function() {
    return window.weiboUI.getWeiboMainHTML();
};

window.bindWeiboEvents = function() {
    if (window.weiboUI) {
        window.weiboUI.bindEvents();
    }
};
```

### 与上下文编辑器集成
```javascript
// 获取聊天数据
const chatData = window.mobileContextEditor.getCurrentChatData();

// 修改消息内容
const success = await window.mobileContextEditor.modifyMessage(0, newContent);

// 添加新消息
const messageIndex = await window.mobileContextEditor.addMessage(content, false, '微博系统');
```

### 与API配置集成
```javascript
// 检查API可用性
if (!window.mobileCustomAPIConfig || !window.mobileCustomAPIConfig.isAPIAvailable()) {
    throw new Error('请先配置API');
}

// 调用API
const response = await window.mobileCustomAPIConfig.callAPI(messages, options);
```

这种模块化、事件驱动的架构确保了微博应用的稳定性、可维护性和扩展性。
