# 朋友圈功能开发计划

## 项目概述

为现有的message-app添加朋友圈功能，实现类似微信朋友圈的社交体验。基于对现有代码架构的深入学习，制定了完整的技术方案和实施计划。

## 学习成果总结

### 1. 现有应用架构分析

#### Message App 架构特点
- **事件系统**：使用SillyTavern的原生事件系统监听消息
- **智能检测**：多种方式检测事件源（SillyTavern.getContext、全局eventOn、父窗口）
- **增量渲染**：支持增量和全量渲染模式，避免界面跳动
- **实时同步**：集成实时同步器，支持轮询备用方案
- **好友管理**：从上下文解析好友信息，支持头像配置

#### Live App 事件监听机制
- **多层检测**：优先使用SillyTavern.getContext().eventSource
- **备用方案**：全局eventOn函数和父窗口eventSource
- **轮询机制**：事件监听失败时的备用方案
- **消息解析**：使用正则表达式解析特定格式的直播数据

#### Forum App 交互设计
- **点赞系统**：本地状态管理，支持动画效果
- **回复功能**：支持主回复和楼中楼回复
- **弹窗设计**：响应式弹窗，移动端适配
- **API集成**：通过论坛管理器发送回复给AI
- **去重处理**：避免重复解析相同内容

### 2. 文件上传机制
- **Mobile Upload Manager**：专用的移动端文件上传管理器
- **SillyTavern API**：使用/api/files/upload接口
- **多种上传方式**：拖拽、选择文件、粘贴上传
- **文件管理**：支持读取、删除、列表显示

### 3. 样式配置系统
- **Data Bank集成**：使用SillyTavern的Data Bank API存储配置
- **响应式设计**：@media查询实现移动端适配
- **localStorage备用**：Data Bank不可用时的备用存储方案
- **动态样式**：运行时应用样式配置

## 功能需求分析

### 1. UI结构需求
- **页面切换栏**：message-list下方，微博风格底部导航
- **朋友圈页面**：独立header + 用户信息区 + 朋友圈列表
- **用户信息区**：头像、用户名、可编辑签名（localStorage存储）

### 2. 发布功能需求
- **发布入口**：header中的相机图标按钮
- **发布选项**：发文字、发图片两个选项
- **弹窗设计**：参考forum-app，响应式，手机容器定位
- **文件上传**：集成mobile-upload.js功能

### 3. 数据格式需求
```
文字朋友圈：[朋友圈|角色名字|好友id|楼层id|朋友圈内容]
视觉朋友圈：[朋友圈|角色名字|好友id|楼层id|图片描述|文本内容]
朋友圈回复：[朋友圈回复|回复人名字|回复人好友id|楼层id|回复内容]
```

### 4. 交互功能需求
- **点赞功能**：Font Awesome爱心图标，参考forum-app实现
- **回复功能**：Font Awesome聊天气泡图标，输入框+纸飞机发送
- **排序逻辑**：新朋友圈或有新回复的置顶
- **去重处理**：每个朋友圈只显示一次，新回复合并到原帖

## 技术方案

### 1. 架构设计
- **基于message-app扩展**：在现有架构基础上添加朋友圈功能
- **模块化设计**：独立的朋友圈管理器、事件监听器、UI渲染器
- **事件系统复用**：使用live-app的事件监听机制
- **样式系统集成**：使用style-config-manager的响应式设计

### 2. 核心组件

#### FriendsCircleManager（朋友圈管理器）
- 朋友圈数据解析、存储、管理
- 排序和去重逻辑处理
- 点赞和回复数据管理

#### FriendsCircleEventListener（事件监听器）
- 监听SillyTavern消息事件
- 解析朋友圈格式消息
- 触发界面更新

#### FriendsCircleRenderer（UI渲染器）
- 朋友圈列表渲染
- 点赞回复交互处理
- 发布弹窗管理

### 3. 数据结构
```javascript
{
  id: 'q101',
  author: '角色名字',
  friendId: '好友id',
  type: 'text' | 'visual',
  content: '朋友圈内容',
  imageDescription: '图片描述',
  timestamp: Date.now(),
  likes: 0,
  isLiked: false,
  replies: [...]
}
```

## 实施计划

### 阶段1：基础架构搭建（预计2-3天）
1. 扩展message-app.js，添加朋友圈视图状态
2. 创建页面切换栏组件
3. 实现视图切换逻辑
4. 创建朋友圈核心类框架

### 阶段2：UI界面开发（预计3-4天）
1. 设计微博风格的底部导航栏
2. 实现朋友圈页面布局
3. 开发用户信息头部区域
4. 创建发布功能弹窗界面

### 阶段3：核心功能实现（预计4-5天）
1. 集成事件监听系统
2. 实现朋友圈消息格式解析
3. 开发发布功能（文字+图片）
4. 实现点赞和回复系统

### 阶段4：数据处理优化（预计2-3天）
1. 完善消息解析引擎
2. 实现排序和去重逻辑
3. 添加本地存储功能
4. 优化性能和用户体验

### 阶段5：测试和优化（预计2天）
1. 功能测试和bug修复
2. 响应式设计优化
3. 性能优化和代码重构
4. 文档完善

## 技术要点

### 1. 事件监听集成
```javascript
// 复用live-app的智能检测系统
smartDetectEventSystem() {
  // 优先使用SillyTavern.getContext().eventSource
  // 备用全局eventOn和父窗口eventSource
}
```

### 2. 消息格式解析
```javascript
const FRIENDS_CIRCLE_PATTERNS = {
  text: /\[朋友圈\|([^|]+)\|([^|]+)\|([^|]+)\|([^\]]+)\]/g,
  visual: /\[朋友圈\|([^|]+)\|([^|]+)\|([^|]+)\|([^|]+)\|([^\]]+)\]/g,
  reply: /\[朋友圈回复\|([^|]+)\|([^|]+)\|([^|]+)\|([^\]]+)\]/g
};
```

### 3. 文件上传集成
```javascript
// 使用mobile-upload.js的API
await window.mobileUploadManager.uploadFile(file);
```

### 4. 响应式弹窗定位
```javascript
// 使用手机容器定位
const mobileContainer = document.querySelector('.mobile-phone-container');
modal.style.position = 'absolute';
```

## 文件结构
```
app/
├── message-app.js (扩展)
├── friends-circle/
│   ├── friends-circle-manager.js
│   ├── friends-circle-event-listener.js
│   ├── friends-circle-renderer.js
│   ├── friends-circle-ui.js
│   └── friends-circle.css
└── message-app.css (扩展)
```

## 风险评估

### 技术风险
- **事件监听兼容性**：不同SillyTavern版本的API差异
- **消息解析准确性**：复杂格式的正则表达式匹配
- **性能影响**：大量朋友圈数据的渲染性能

### 解决方案
- 多层检测机制确保事件监听稳定性
- 完善的测试用例验证解析准确性
- 虚拟滚动和懒加载优化性能

## 总结

基于对现有代码架构的深入学习，制定了完整的朋友圈功能开发计划。该方案充分复用了现有的技术架构，确保了功能的稳定性和一致性。通过模块化设计和分阶段实施，可以有效控制开发风险，确保项目按时交付。
