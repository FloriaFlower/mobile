# Message App 代码流程详解

## 启动流程

### 1. 初始化入口
```javascript
// mobile-phone.js 第1668行
async handleMessagesApp() {
  const content = await window.getMessageAppContent();
  // 创建 Message App 实例
}
```

### 2. Message App 构造
```javascript
// app/message-app.js 第110行
constructor() {
  this.retryCount = 0;
  this.syncRetryCount = 0;
  this.init();
}
```

### 3. 初始化过程
```javascript
// app/message-app.js 第128行
init() {
  setTimeout(() => {
    this.setupRealtimeMonitor(); // 设置实时监控
  }, 100);
}
```

## 事件监听设置流程

### 步骤1: 启动监控
```javascript
// app/message-app.js 第296-301行
setupRealtimeMonitor() {
  console.log('[Message App] 设置SillyTavern原生事件监控...');
  this.setupSillyTavernEventListeners();
}
```

### 步骤2: 智能检测事件系统
```javascript
// app/message-app.js 第522行
const detectionResult = this.smartDetectEventSystem();
```

#### 检测方法详解

**方法1: 直接全局访问**
```javascript
() => ({
  eventSource: window['eventSource'],
  event_types: window['event_types'],
})
```

**方法2: SillyTavern对象**
```javascript
() => ({
  eventSource: window['SillyTavern']?.eventSource,
  event_types: window['SillyTavern']?.event_types,
})
```

**方法3: ST简写**
```javascript
() => ({
  eventSource: window['ST']?.eventSource,
  event_types: window['ST']?.event_types,
})
```

**方法4: 深度搜索**
```javascript
() => {
  const globalKeys = Object.keys(window);
  for (const key of globalKeys) {
    try {
      const obj = window[key];
      if (obj && typeof obj === 'object') {
        if (obj.eventSource && obj.event_types) {
          return {
            eventSource: obj.eventSource,
            event_types: obj.event_types,
            foundIn: key,
          };
        }
      }
    } catch (e) {
      // 忽略访问错误
    }
  }
  return null;
}
```

**方法5: 事件发射器查找**
```javascript
() => {
  const globalKeys = Object.keys(window);
  for (const key of globalKeys) {
    try {
      const obj = window[key];
      if (obj && typeof obj === 'object' && typeof obj.on === 'function') {
        const possibleEventTypes = window[key + '_types'] || 
                                  window[key.replace(/Source$/, '_types')];
        if (possibleEventTypes) {
          return {
            eventSource: obj,
            event_types: possibleEventTypes,
            foundIn: key,
          };
        }
      }
    } catch (e) {
      // 忽略访问错误
    }
  }
  return null;
}
```

### 步骤3: 处理检测结果

#### 成功情况
```javascript
if (detectionResult.found) {
  console.log('[Message App] ✅ 智能检测找到事件系统:', detectionResult);
  eventSource = detectionResult.eventSource;
  event_types = detectionResult.event_types;
  // 设置事件监听器...
}
```

#### 失败情况
```javascript
if (!eventSource || !event_types) {
  console.warn('[Message App] SillyTavern事件系统未准备就绪，延迟监听...');
  
  if (!this.retryCount) this.retryCount = 0;
  this.retryCount++;
  
  if (this.retryCount <= 5) {
    console.log(`[Message App] 重试次数: ${this.retryCount}/5`);
    setTimeout(() => {
      this.setupSillyTavernEventListeners();
    }, 1000 + this.retryCount * 200);
  } else {
    console.error('[Message App] 达到最大重试次数，切换到轮询模式');
    this.fallbackToPolling();
  }
  return;
}
```

## 轮询模式流程

### 启动轮询
```javascript
// app/message-app.js 第976-979行
fallbackToPolling() {
  console.warn('[Message App] 回退到轮询模式...');
  this.startSimplePolling();
}
```

### 轮询实现
```javascript
// app/message-app.js 第988-994行
startSimplePolling() {
  console.log('[Message App] 启动简单轮询监控（备选方案）...');
  
  setInterval(() => {
    this.checkForNewMessages();
  }, 2000); // 每2秒检查一次
}
```

### 消息检查
```javascript
// app/message-app.js 第997-1020行
checkForNewMessages() {
  try {
    const chatData = this.getSillyTavernChatData();
    if (!chatData) {
      return;
    }
    
    // 检查消息变化
    const currentMessageCount = chatData.length;
    if (this.lastMessageCount !== currentMessageCount) {
      console.log('[Message App] 检测到新消息，更新界面...');
      this.lastMessageCount = currentMessageCount;
      this.refreshMessages();
    }
  } catch (error) {
    console.error('[Message App] 轮询检查消息失败:', error);
  }
}
```

## 数据获取方式

### SillyTavern 数据获取
```javascript
// app/message-app.js 第1050-1080行
getSillyTavernChatData() {
  try {
    // 多种方式尝试获取聊天数据
    const chatData = window.chat || 
                    window.SillyTavern?.chat || 
                    window.ST?.chat;
    return chatData;
  } catch (error) {
    console.error('[Message App] 获取SillyTavern聊天数据失败:', error);
    return null;
  }
}
```

## 关键变量说明

- **this.retryCount**: 事件监听重试次数计数器
- **this.syncRetryCount**: 同步重试次数计数器  
- **this.lastMessageCount**: 上次检查的消息数量（用于轮询比较）
- **eventSource**: SillyTavern 的事件发射器对象
- **event_types**: SillyTavern 的事件类型定义对象

## 调试建议

### 检查 SillyTavern 对象
在浏览器控制台运行：
```javascript
console.log('window.eventSource:', window.eventSource);
console.log('window.event_types:', window.event_types);
console.log('window.SillyTavern:', window.SillyTavern);
console.log('window.ST:', window.ST);
```

### 手动触发检测
```javascript
// 获取 Message App 实例并手动触发检测
const messageApp = window.currentMessageApp;
if (messageApp) {
  const result = messageApp.smartDetectEventSystem();
  console.log('检测结果:', result);
}
```
