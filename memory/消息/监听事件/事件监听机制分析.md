# Message App 事件监听机制分析

## 控制台报错分析

### 报错内容
```
[Message App] 🧠 开始智能检测事件系统...
[Message App] ❌ 所有检测方法都失败了
[Message App] SillyTavern事件系统未准备就绪，延迟监听...
[Message App] 重试次数: 5/5
[Message App] 达到最大重试次数，切换到轮询模式
[Message App] 回退到轮询模式...
[Message App] 启动简单轮询监控（备选方案）...
```

### 问题原因
Message App 无法找到 SillyTavern 的事件系统（eventSource 和 event_types），导致实时事件监听失败，最终回退到轮询模式。

## 事件监听机制详解

### 1. 主要监听方式

Message App 使用两种方式监听 SillyTavern 的消息变化：

#### 方式一：事件监听（首选）
- **位置**: `app/message-app.js` 第520-700行
- **方法**: `setupSillyTavernEventListeners()` 和 `smartDetectEventSystem()`
- **原理**: 监听 SillyTavern 的原生事件系统，实时获取消息更新

#### 方式二：轮询监听（备选）
- **位置**: `app/message-app.js` 第976-1020行
- **方法**: `fallbackToPolling()` 和 `startSimplePolling()`
- **原理**: 每2秒检查一次消息变化，作为事件监听失败时的备选方案

### 2. 智能检测机制

#### 检测目标
程序需要找到两个关键对象：
- `eventSource`: SillyTavern 的事件发射器
- `event_types`: SillyTavern 的事件类型定义

#### 检测方法（5种）
1. **直接全局访问**: `window.eventSource` 和 `window.event_types`
2. **SillyTavern对象**: `window.SillyTavern.eventSource`
3. **ST简写**: `window.ST.eventSource`
4. **深度搜索**: 遍历所有全局对象寻找包含事件系统的对象
5. **事件发射器查找**: 寻找具有 `.on()` 方法的对象

### 3. 重试机制

#### 重试逻辑
- **最大重试次数**: 5次
- **重试间隔**: 1000ms + 重试次数 × 200ms
- **失败处理**: 达到最大重试次数后切换到轮询模式

#### 代码位置
```javascript
// app/message-app.js 第535-548行
if (this.retryCount <= 5) {
  console.log(`[Message App] 重试次数: ${this.retryCount}/5`);
  setTimeout(() => {
    this.setupSillyTavernEventListeners();
  }, 1000 + this.retryCount * 200);
} else {
  console.error('[Message App] 达到最大重试次数，切换到轮询模式');
  this.fallbackToPolling();
}
```

## 当前运行状态

### 实际使用的方法
根据控制台输出，当前使用的是 **轮询模式**：
- 事件监听检测失败（所有5种检测方法都失败）
- 自动切换到轮询模式
- 每2秒检查一次消息变化

### 轮询模式工作原理
```javascript
// app/message-app.js 第988-994行
startSimplePolling() {
  console.log('[Message App] 启动简单轮询监控（备选方案）...');
  
  setInterval(() => {
    this.checkForNewMessages();
  }, 2000); // 每2秒检查一次
}
```

## 问题分析

### 为什么事件监听失败？

1. **SillyTavern 未完全加载**: 事件系统可能还没有初始化
2. **对象路径变化**: SillyTavern 更新后事件系统的访问路径可能发生变化
3. **加载时序问题**: Message App 加载时间早于 SillyTavern 事件系统初始化

### 影响
- **功能正常**: 轮询模式仍能正常获取消息更新
- **性能影响**: 轮询比事件监听消耗更多资源
- **实时性**: 轮询有2秒延迟，事件监听是即时的

## 解决建议

### 短期解决方案
当前轮询模式工作正常，不影响基本功能使用。

### 长期优化方案
1. **增加检测方法**: 添加更多 SillyTavern 事件系统的检测路径
2. **延长重试时间**: 增加初始化等待时间
3. **动态检测**: 在轮询过程中继续尝试检测事件系统

## 相关文件

- **主要逻辑**: `app/message-app.js`
- **初始化**: `mobile-phone.js` (调用 Message App)
- **上下文监控**: `context-monitor.js`
- **消息渲染**: `app/message-renderer.js`
