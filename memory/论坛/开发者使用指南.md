# 论坛系统开发者使用指南

## 快速开始

### 1. 系统初始化
论坛系统会在移动端扩展加载时自动初始化。初始化过程包括：
- 加载用户设置
- 启动自动监听器
- 创建UI界面
- 注册控制台命令

### 2. 基本配置
在使用论坛功能前，需要配置AI API：
1. 打开论坛控制面板
2. 点击"API设置"按钮
3. 配置API地址、密钥和模型
4. 测试连接确保配置正确

### 3. 启用自动生成
- 确保"自动生成论坛内容"选项已开启
- 设置合适的消息阈值（建议5-15条）
- 选择喜欢的论坛风格

## 核心API接口

### ForumManager 类

#### 主要方法
```javascript
// 生成论坛内容
await forumManager.generateForumContent(force = false)

// 清除论坛内容
await forumManager.clearForumContent()

// 发送回复到API
await forumManager.sendReplyToAPI(replyFormat)

// 发送新帖到API
await forumManager.sendPostToAPI(postFormat)

// 直接插入回复到第一层
await forumManager.insertReplyToFirstLayer(replyPrefix, replyFormat)
```

#### 设置管理
```javascript
// 保存设置
forumManager.saveSettings()

// 加载设置
forumManager.loadSettings()

// 当前设置结构
{
    enabled: true,
    selectedStyle: '贴吧老哥',
    autoUpdate: true,
    threshold: 10,
    apiConfig: {
        url: '',
        apiKey: '',
        model: ''
    }
}
```

### ForumAutoListener 类

#### 控制方法
```javascript
// 启动监听
forumAutoListener.start()

// 停止监听
forumAutoListener.stop()

// 获取调试信息
forumAutoListener.getDebugInfo()
```

#### 配置选项
```javascript
{
    enabled: true,
    checkIntervalMs: 5000,      // 检查间隔
    debounceMs: 500,            // 防抖延迟
    immediateOnThreshold: true, // 达到阈值立即执行
    maxRetries: 3,              // 最大重试次数
    autoStartWithUI: true       // 随UI自动启停
}
```

### ForumUI 类

#### 主要方法
```javascript
// 解析论坛内容
forumUI.parseForumContent(content)

// 显示论坛界面
forumUI.showForumInterface()

// 刷新帖子列表
forumUI.refreshThreadList()

// 处理用户回复
forumUI.handleUserReply(threadId, content)
```

### ForumStyles 类

#### 风格管理
```javascript
// 获取风格提示词
forumStyles.getStylePrompt(styleName)

// 设置自定义前缀
forumStyles.setCustomPrefix(prefix)

// 获取自定义前缀
forumStyles.getCustomPrefix()

// 获取所有可用风格
forumStyles.getAvailableStyles()
```

## 控制台命令参考

### 基本操作命令
```javascript
// 生成论坛内容
MobileContext.generateForum(force=true)        // 默认强制生成
MobileContext.forceGenerateForum()             // 强制生成（无视阈值）
MobileContext.autoGenerateForum()              // 按规则自动生成

// 界面控制
MobileContext.showForum()                      // 显示论坛面板
MobileContext.showForumPanel()                 // 显示论坛面板
MobileContext.clearForum()                     // 清除论坛内容
MobileContext.clearForumCache()                // 刷新论坛界面

// 内容操作
MobileContext.sendReply(replyFormat)           // 发送回复
MobileContext.insertReply(prefix, format)      // 直接插入回复
MobileContext.sendPost(postFormat)             // 发送新帖
```

### 状态和调试命令
```javascript
// 状态查询
MobileContext.getForumStatus()                 // 获取论坛状态
MobileContext.getListenerStatus()              // 获取监听器状态
MobileContext.checkGenerating()                // 检查生成状态
MobileContext.getQueueStatus()                 // 获取队列状态

// 调试测试
MobileContext.testForceGenerate()              // 测试强制生成
MobileContext.testDuplicateProtection()        // 测试重复请求防护
MobileContext.simulateMessageSpam(count)       // 模拟消息轰炸

// 状态重置
MobileContext.forceReset()                     // 强制重置所有状态
MobileContext.resetForumState()                // 重置论坛状态
MobileContext.clearQueue()                     // 清空队列
```

### 监听器控制命令
```javascript
// 监听器控制
MobileContext.startAutoListener()              // 启动自动监听器
MobileContext.stopAutoListener()               // 停止自动监听器
MobileContext.getAutoListenerDebug()           // 获取监听器调试信息
```

### 浏览器兼容性命令
```javascript
// 兼容性修复
MobileContext.fixBrowserCompatibility()        // 修复Safari/Via兼容性
MobileContext.quickDiagnosis()                 // 快速诊断按钮问题
```

## 自定义开发

### 1. 添加新的论坛风格

在 `forum-styles.js` 中添加新风格：
```javascript
// 在 initializeStyles() 方法中添加
'新风格名称': `你的风格提示词内容...`
```

### 2. 扩展UI功能

在 `forum-ui.js` 中添加新的UI组件：
```javascript
// 添加新的渲染方法
renderCustomComponent() {
    // 你的UI代码
}
```

### 3. 自定义事件处理

```javascript
// 监听论坛事件
document.addEventListener('forumContentGenerated', (event) => {
    console.log('论坛内容已生成:', event.detail);
});

document.addEventListener('forumContentCleared', (event) => {
    console.log('论坛内容已清除');
});
```

### 4. 扩展API功能

```javascript
// 自定义API调用
class CustomForumAPI {
    async callCustomAPI(messages, options) {
        // 你的自定义API逻辑
    }
}
```

## 最佳实践

### 1. 性能优化
- 合理设置检查间隔和阈值
- 及时清理缓存和队列
- 避免频繁的API调用

### 2. 错误处理
- 始终使用try-catch包装异步操作
- 提供用户友好的错误信息
- 实现优雅的降级处理

### 3. 用户体验
- 提供清晰的状态反馈
- 实现响应式设计
- 考虑不同浏览器的兼容性

### 4. 数据管理
- 定期备份重要设置
- 合理使用localStorage
- 避免数据冲突和丢失

## 调试技巧

### 1. 日志分析
- 开启详细日志模式
- 关注关键操作的日志输出
- 使用浏览器开发者工具

### 2. 状态监控
- 定期检查系统状态
- 监控API调用情况
- 观察内存使用情况

### 3. 问题定位
- 使用控制台命令快速诊断
- 分步骤测试功能模块
- 查看网络请求状态

## 部署注意事项

### 1. 依赖检查
确保以下模块已正确加载：
- mobileContextEditor（上下文编辑器）
- mobileCustomAPIConfig（API配置）
- forumStyles（风格定义）

### 2. 初始化顺序
论坛系统的初始化依赖于其他模块，确保按正确顺序加载。

### 3. 浏览器兼容性
特别测试Safari和Via浏览器的兼容性，必要时启用兼容性修复。

### 4. API配置
确保API服务稳定可用，配置合适的超时和重试机制。

通过遵循这些指南，开发者可以有效地使用和扩展论坛系统功能。
